<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="Styles/style.css" rel="stylesheet" />
    <link href="Styles/bootstrap/bootstrap.css" rel="stylesheet" />
    <script src="Scripts/jquery-2.0.3.js"></script>
    <script src="Scripts/benchmark.js"></script>
    <script src="Scripts/common.js"></script>
    <script src="Scripts/graphics.js"></script>
    <script src="Scripts/lsystem.js"></script>
    <script type="text/javascript">

        var canvas;
        var expr;

        $(function () {

            showInfo("a");
            showInfo("b");
            showInfo("c");

            // 初始化
            init();
        });

        function init() {
            canvas = $('#drawCanvas')[0];

            var expr_editor_container = $('#expr_editor_container');
            expr_editor_container.css('top', canvas.height + 15);

            var expr_editor = $('#exprEditor');
            expr_editor.css('width', canvas.width);

            $('#txtOrgX').val(canvas.width / 2);
            $('#txtOrgY').val(canvas.height - 50);
        }

        function drawGrid(cxt, step) {
            var cw = canvas.width;
            var ch = canvas.height;
            
            cxt.strokeStyle = 'gray';

            cxt.beginPath();
            for (var x = 0; x < cw; x += step) {
                for (var y = 0; y < ch; y += step) {
                    cxt.moveTo(0, y);
                    cxt.lineTo(cw, y);

                    cxt.moveTo(x, 0);
                    cxt.lineTo(x, ch);
                }
            }
            cxt.stroke();
            cxt.closePath();
        }

        function render_bm() {
            var benchmark = new Benchmark('LSystem::render', render);          
            benchmark.run();
        }

        function render() {            
            var cxt = canvas.getContext('2d');
            if ($('#chkDrawGrid')[0].checked) {              
                // 绘制网格
                var step = parseInt($('#txtStep').val());
                drawGrid(cxt, step);
            }

            var depth = parseInt($('#txtDepth').val());
            var axiom = $('#txtAxiom').val();
            var rules = {};
            for(var i = 1; i < 5; i++) {
                var rule0 = $('#txtRuleLeft' + i).val();               
                var rule = $('#txtRule' + i).val();
                if(rule0 == "") continue; 
                rules[rule0] = rule;
            }

            var ls = new LSystem();
            var expr = ls.generate(axiom, rules, depth);
            $('#exprEditor').val(expr);

            var angle = parseFloat($('#txtAngle').val())
            var deltaAngle = parseFloat($('#txtDeltaAngle').val());
            var step = parseFloat($('#txtStep').val());
            var orgX = parseInt($('#txtOrgX').val());
            var orgY = parseInt($('#txtOrgY').val());

            var g = new Graphics(canvas, true);
            ls.render(g, expr, {
                origin: { x: orgX, y: orgY },
                angle: angle,
                step: step,
                deltaAngle: deltaAngle
            });
        }

        function showInfo(str, type) {          
            var d = new Date();
            var msg = d.toLocaleString() + ' ' + str;
            var span = $('<span>' + msg + '</span><br>');
            $('#output').prepend(span);
        }

    </script>
</head>
<body>
    <div class="canvas_container">
        <canvas id="drawCanvas" width="500" height="500" class="canvas"></canvas>
    </div>
    <div id="expr_editor_container" class="expr_editor_container">
        <textarea id="exprEditor" class="expr_editor"></textarea>
    </div>
    <div id="option_container" class="option_table_container">
        <table class="table option_table">
            <thead>
                <tr>
                    <td class="option_table_cell_title">Options</td>
                    <td class="option_table_cell_value">Values</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="option_table_cell_title">Step</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtStep" class="option_text" value="5" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Angle</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtAngle" class="option_text" value="90" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">DeltaAngle</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtDeltaAngle" class="option_text" value="20" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Depth</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtDepth" class="option_text" value="10" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Axiom</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtAxiom" class="option_text" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Rule 1</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtRuleLeft1" class="option_rule_left" value="" />
                        <span>-></span>
                        <input type="text" id="txtRule1" class="option_rule" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Rule 2</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtRuleLeft2" class="option_rule_left" value="" />
                        <span>-></span>
                        <input type="text" id="txtRule2" class="option_rule" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Rule 3</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtRuleLeft3" class="option_rule_left" value="" />
                        <span>-></span>
                        <input type="text" id="txtRule3" class="option_rule" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Rule 4</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtRuleLeft4" class="option_rule_left" value="" />
                        <span>-></span>
                        <input type="text" id="txtRule4" class="option_rule" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Rule 5</td>
                    <td class="option_table_cell_value">
                        <input type="text" id="txtRuleLeft5" class="option_rule_left" value="" />
                        <span>-></span>
                        <input type="text" id="txtRule5" class="option_rule" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="option_table_cell_title">Origin</td>
                    <td class="option_table_cell_value">
                        X=<input type="text" id="txtOrgX" class="option_text" style="width:85%;" />
                        Y=<input type="text" id="txtOrgY" class="option_text" style="width:85%;"/>
                    </td>
                </tr>                
                <tr>
                    <td class="option_table_cell_title">Show Grid</td>
                    <td class="option_table_cell_value">
                        <input type="checkbox" id="chkDrawGrid" /> Show grid on canvas
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">
                        <input type="button" value="Render" onclick="render_bm();" />
                        <input type="button" value="Single Step" />
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    <div id="output" class="bm_container with_red_board">
    </div>
</body>
</html>
