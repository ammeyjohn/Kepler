<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="Styles/bootstrap/bootstrap.css" rel="stylesheet" />
    <link href="Styles/style.css" rel="stylesheet" />
    <script src="Scripts/jquery/jquery-2.0.3.js"></script>
    <script src="Scripts/benchmark/benchmark.js"></script>
    <script src="Scripts/common.js"></script>
    <script src="Scripts/graphics.js"></script>
    <script src="Scripts/lsystem.js"></script>
    <script type="text/javascript">

        var drawPane;
        var expr;

        $(function () {
            // 初始化
            drawPane = $('#drawPane')[0];
        });

        function addRule() {
            var ruleLeft = $('#prop_rule_left');
            var rule = $('#prop_rule');

            var span = $('<span>');
            span.append(ruleLeft.val() + '->' + rule.val());

            $('#prop_rules').append(span);
            $('#prop_rules').append('<br>');

            ruleLeft.val('');
            rule.val('');
        }

        function removeRule() {
        }

        function drawGrid(cxt, step) {
            var cw = drawPane.width;
            var ch = drawPane.height;

            cxt.strokeStyle = 'gray';

            cxt.beginPath();
            for (var x = 0; x < cw; x += step) {
                for (var y = 0; y < ch; y += step) {
                    cxt.moveTo(0, y);
                    cxt.lineTo(cw, y);

                    cxt.moveTo(x, 0);
                    cxt.lineTo(x, ch);
                }
            }
            cxt.stroke();
            cxt.closePath();
        }

        function render() {
            var cxt = drawPane.getContext('2d');
            if ($('#chkDrawGrid')[0].checked) {
                // 绘制网格
                var step = parseInt($('#txtStep').val());
                drawGrid(cxt, step);
            }

            var depth = parseInt($('#txtDepth').val());
            var axiom = $('#txtAxiom').val();
            var rules = {};
            for (var i = 1; i < 5; i++) {
                var rule0 = $('#txtRuleLeft' + i).val();
                var rule = $('#txtRule' + i).val();
                if (rule0 == "") continue;
                rules[rule0] = rule;
            }

            var ls = new LSystem();
            var expr = ls.generate(axiom, rules, depth);
            $('#exprEditor').val(expr);

            var angle = parseFloat($('#txtAngle').val())
            var deltaAngle = parseFloat($('#txtDeltaAngle').val());
            var step = parseFloat($('#txtStep').val());
            var orgX = parseInt($('#txtOrgX').val());
            var orgY = parseInt($('#txtOrgY').val());

            var g = new Graphics(drawPane, true);
            ls.render(g, expr, {
                origin: { x: orgX, y: orgY },
                angle: angle,
                step: step,
                deltaAngle: deltaAngle
            });
        }

    </script>
</head>
<body>
    <div class="drawPane_container">
        <canvas id="drawPane" width="500" height="500" class="drawPane"></canvas>
    </div>
    <div class="expr_container">
        <textarea id="expression" class="expression"></textarea>
    </div>
    <div class="prop_container">
        <table class="table prop_table">
            <thead>
                <tr>
                    <td class="prop_cell prop_head prop_name">属性</td>
                    <td class="prop_cell prop_head prop_value">属性值</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="prop_cell">Origin X</td>
                    <td class="prop_cell">
                        <input id="prop_org_x" type="number" class="prop_input" value="250" />
                    </td>
                </tr>
                <tr>
                    <td class="prop_cell">Origin Y</td>
                    <td class="prop_cell">
                        <input id="prop_org_y" type="number" class="prop_input" value="250" />
                    </td>
                </tr>
                <tr>
                    <td class="prop_cell">Angle</td>
                    <td class="prop_cell">
                        <input id="prop_angle" type="number" class="prop_input" value="90" />
                    </td>
                </tr>
                <tr>
                    <td class="prop_cell">Delta Angle</td>
                    <td class="prop_cell">
                        <input id="prop_delta_angle" type="number" class="prop_input" />
                    </td>
                </tr>
                <tr>
                    <td class="prop_cell">Delta Length</td>
                    <td class="prop_cell">
                        <input id="prop_delta_length" type="number" class="prop_input" />
                    </td>
                </tr>
                <tr>
                    <td class="prop_cell">Axiom</td>
                    <td class="prop_cell">
                        <input id="prop_axiom" type="text" class="prop_input" />
                    </td>
                </tr>
                <tr>
                    <td class="prop_cell">Rules</td>
                    <td class="prop_cell">
                        <div id="prop_rules" class="prop_rules">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input id="prop_rule_left" style="width: 40px;"/>
                        ->
                        <input id="prop_rule" style="width: 75%;"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: right;">
                        <input type="button" value="Add" onclick="addRule();"/>
                        <input type="button" value="Remove" onclick="removeRule();"/>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" class="prop_cell">
                        <input type="button" value="render" />
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</body>
</html>
